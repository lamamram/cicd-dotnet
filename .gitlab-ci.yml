# image par défaut des jobs du pipeline
# utilisation du registre d'image privé
# utilisation d'une variable d'environnement
image: $CI_REGISTRY_IMAGE/dotnet-sdk:3.1-debian-11

# liste des étapes d'exécution du pipeline
stages:
  - testing
  - building
  - deploying

variables:
  TRIGGER_CACHE: "on"

# génération des dépendances des projets
restore:
  stage: .pre
  script:
    - dotnet restore
    - ls -al /app/.nuget
  tags:
    - myusine
  # génération d'un cache mis à disposition des autres jobs
  cache:
    key: nuget
    paths:
      - /app/.nuget/packages/
    policy: push
  rules:
    - changes:
        - "**/*.csproj"
    - if: $TRIGGER_CACHE == "on"

unit test:
  # association du job à un stage
  stage: testing
  script:
    - dotnet test --no-restore
  tags:
    - myusine
  # récupération du cache
  # on exécute les tests sans demander l'install des déps (--no-restore)
  cache:
    key: nuget
    untracked: true
    policy: pull

# préfixer un job par "." desactive le job
.build:
  stage: building
  script:
    - echo "Build"
  tags:
    - myusine

# job de déploiement
# s'exécute uniquement sur master et manuellement (livraison continue)
.prod:
  stage: deploying
  script:
    - echo "Deploy !"
  tags:
    - myusine
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual

